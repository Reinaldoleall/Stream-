<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Transfer via QR Code</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
    <style>
        :root { --background: #111827; --surface: #1f2937; --primary: #3b82f6; --text: #f9fafb; --text-secondary: #9ca3af; --border: #4b5563; --success: #10b981; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--background); color: var(--text); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .container { max-width: 500px; width: 100%; background: var(--surface); padding: 2.5rem; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; }
        .hidden { display: none !important; }
        h1 { margin-bottom: 1rem; }
        p { color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6; }
        .btn { display: inline-block; width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: bold; color: white; background: var(--primary); border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        #file-input { display: none; }
        #qr-canvas { display: block; margin: 2rem auto; border-radius: 8px; background: white; padding: 1rem; }
        .status-box { margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .progress-bar { width: 100%; height: 12px; background: #374151; border-radius: 6px; margin-top: 1rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <div id="receiver-view">
            <h1>Receber Arquivo</h1>
            <p>Escaneie o QR Code abaixo com o dispositivo que irá enviar o arquivo.</p>
            <canvas id="qr-canvas"></canvas>
            <div id="receiver-status" class="status-box">Aguardando conexão...</div>
        </div>

        <div id="sender-view" class="hidden">
            <h1>Enviar Arquivo</h1>
            <p>Conectado! Selecione o arquivo que deseja enviar.</p>
            <button class="btn" onclick="document.getElementById('file-input').click()">Selecionar Arquivo</button>
            <input type="file" id="file-input">
            <div id="sender-status" class="status-box">Pronto para enviar.</div>
            <div id="sender-progress-bar" class="progress-bar hidden"><div class="progress-fill"></div></div>
        </div>
    </div>

    <script>
        const receiverView = document.getElementById('receiver-view');
        const senderView = document.getElementById('sender-view');
        const receiverStatus = document.getElementById('receiver-status');
        const senderStatus = document.getElementById('sender-status');
        const fileInput = document.getElementById('file-input');
        const senderProgressBar = document.getElementById('sender-progress-bar');
        
        let peer = null;
        let connection = null;
        const CHUNK_SIZE = 16384; // 16KB

        function initialize() {
            const params = new URLSearchParams(window.location.search);
            const receiverId = params.get('connect_to');

            if (receiverId) {
                // Modo Transmissor
                initializeSender(receiverId);
            } else {
                // Modo Receptor
                initializeReceiver();
            }
        }

        // --- LÓGICA DO RECEPTOR ---
        function initializeReceiver() {
            receiverView.classList.remove('hidden');
            senderView.classList.add('hidden');
            
            peer = new Peer(); // Pede uma ID ao servidor de sinalização

            peer.on('open', (id) => {
                const baseUrl = window.location.href.split('?')[0];
                const connectUrl = `${baseUrl}?connect_to=${id}`;
                
                receiverStatus.textContent = `Sua ID de conexão é: ${id}`;
                QRCode.toCanvas(document.getElementById('qr-canvas'), connectUrl, { width: 256 });
            });

            peer.on('connection', (conn) => {
                connection = conn;
                receiverStatus.textContent = `Dispositivo conectado! Aguardando arquivo...`;

                let receivedFileBuffer = [];
                let fileMetadata = {};

                conn.on('data', (data) => {
                    if (data.type === 'metadata') {
                        fileMetadata = data.payload;
                        receivedFileBuffer = [];
                        receiverStatus.textContent = `Recebendo arquivo: ${fileMetadata.name} (${(fileMetadata.size / 1024 / 1024).toFixed(2)} MB)`;
                    } else if (data.type === 'chunk') {
                        receivedFileBuffer.push(data.payload);
                        const progress = (receivedFileBuffer.length * CHUNK_SIZE / fileMetadata.size) * 100;
                        receiverStatus.textContent = `Recebendo... ${Math.round(progress)}%`;
                    } else if (data.type === 'done') {
                        const receivedBlob = new Blob(receivedFileBuffer, { type: fileMetadata.type });
                        triggerDownload(receivedBlob, fileMetadata.name);
                        receiverStatus.textContent = `Arquivo "${fileMetadata.name}" recebido com sucesso!`;
                        conn.close();
                    }
                });
            });

             peer.on('error', (err) => {
                console.error(err);
                receiverStatus.textContent = `Erro: ${err.type}. Tente recarregar a página.`;
            });
        }
        
        // --- LÓGICA DO TRANSMISSOR ---
        function initializeSender(receiverId) {
            senderView.classList.remove('hidden');
            receiverView.classList.add('hidden');
            
            peer = new Peer();

            peer.on('open', () => {
                senderStatus.textContent = `Conectando ao dispositivo receptor...`;
                connection = peer.connect(receiverId);

                connection.on('open', () => {
                    senderStatus.textContent = `Conectado! Selecione um arquivo para enviar.`;
                    fileInput.addEventListener('change', handleFileSelect);
                });
                 connection.on('error', (err) => {
                    console.error(err);
                    senderStatus.textContent = `Erro na conexão. Verifique se o receptor está ativo.`;
                });
            });

            peer.on('error', (err) => {
                console.error(err);
                senderStatus.textContent = `Erro: ${err.type}. Verifique sua conexão e tente novamente.`;
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !connection) return;

            senderStatus.textContent = `Enviando: ${file.name}`;
            senderProgressBar.classList.remove('hidden');
            const progressBarFill = senderProgressBar.querySelector('.progress-fill');
            
            // 1. Enviar metadados primeiro
            connection.send({
                type: 'metadata',
                payload: { name: file.name, type: file.type, size: file.size }
            });

            // 2. Enviar arquivo em pedaços (chunks)
            const fileReader = new FileReader();
            let offset = 0;

            fileReader.addEventListener('load', e => {
                connection.send({ type: 'chunk', payload: e.target.result });
                offset += e.target.result.byteLength;
                
                const progress = (offset / file.size) * 100;
                progressBarFill.style.width = `${progress}%`;

                if (offset < file.size) {
                    readSlice(offset);
                } else {
                    // 3. Enviar sinal de conclusão
                    connection.send({ type: 'done' });
                    senderStatus.textContent = `Arquivo "${file.name}" enviado com sucesso!`;
                    setTimeout(() => connection.close(), 1000);
                }
            });

            function readSlice(o) {
                const slice = file.slice(o, o + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            }
            
            readSlice(0); // Inicia o processo de leitura
        }

        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Inicia a aplicação
        initialize();
    </script>
</body>
</html>

